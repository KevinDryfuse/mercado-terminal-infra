jobs:
  terraform:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        client: [dg]

    name: ğŸ› ï¸ Terraform - ${{ matrix.client }}

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ§° Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: ğŸ§  Map Secrets for Client
        run: |
          echo "ARM_SUBSCRIPTION_ID=${{ secrets.AZURE_SUBSCRIPTION_ID }}" >> $GITHUB_ENV
          echo "TF_LOG=DEBUG" >> $GITHUB_ENV
          echo "TF_LOG_PATH=terraform.log" >> $GITHUB_ENV
          if [[ "${{ matrix.client }}" == "dg" ]]; then
            echo "TF_VAR_db_admin_user=${{ secrets.TF_VAR_DB_ADMIN_USER_DG }}" >> $GITHUB_ENV
            echo "TF_VAR_db_admin_password=${{ secrets.TF_VAR_DB_ADMIN_PASSWORD_DG }}" >> $GITHUB_ENV
          fi

      - name: ğŸ”§ Terraform Init
        run: terraform -chdir=envs/${{ matrix.client }} init -input=false -no-color

      - name: âœ… Terraform Validate
        run: terraform -chdir=envs/${{ matrix.client }} validate -no-color

      - name: ğŸ” Terraform Plan
        run: terraform -chdir=envs/${{ matrix.client }} plan -input=false -no-color

      - name: ğŸ§¾ Dump Terraform Log (always runs)
        if: always()
        run: |
          echo "--------- ğŸ“œ Terraform Log ---------"
          cat terraform.log || echo "âš ï¸ No terraform.log file found."

      - name: ğŸš€ Terraform Apply
        if: github.event.pull_request.merged == true
        run: terraform -chdir=envs/${{ matrix.client }} apply -auto-approve -input=false -no-color
